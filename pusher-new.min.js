!function(){function e(){var e=!!navigator.userAgent.match(/Version\/[\d\.]+.*Safari/),o=navigator.serviceWorker;if(s(),e||!o)return i({domain:settingsProvider.domainName,event:"subscriptionDenied",reason:"unsupported"},callbackProvider.onUnsupported);navigator.serviceWorker.register("/service-worker.js").then(function(e){"denied"===Notification.permission&&i({domain:settingsProvider.domainName,event:"subscriptionDenied",reason:"denied"},callbackProvider.onDenied),"granted"===Notification.permission&&e.pushManager.getSubscription().then(function(e){e?t(e.toJSON()).then(callbackProvider.onSubscribed):r(callbackProvider.onSubscribe)}).catch(function(e){console.log("Push subscription error")}),"default"==Notification.permission&&callbackProvider.onInit(n)}).catch(function(e){console.log("Error registering SW: ",e)})}function n(){Notification.requestPermission(function(e){"default"==e&&callbackProvider.onDefault(),"denied"==e&&i({domain:settingsProvider.domainName,event:"subscriptionDenied",reason:"denied"},callbackProvider.onDenied),"granted"==e&&r(callbackProvider.onSubscribe)})}function i(e,n){if(d)return console.log("notifyRequest",e),n();if(e.url=location.href.split("#")[0],window.fetch)return fetch(settingsProvider.endpointDomain+"/notify?name="+settingsProvider.domainURL,{method:"POST",mode:"cors",credentials:"include",body:JSON.stringify(e),headers:{"content-type":"text/json"}}).then(n).catch(function(e){console.log(e)});if(-1==document.cookie.indexOf("pushcentric_lns=1")){document.cookie="pushcentric_lns=1";var i=document.createElement("form"),t=document.createElement("iframe");i.method="POST",i.action=settingsProvider.endpointDomain+"/notify?name="+settingsProvider.domainURL,t.style.opacity=0,t.width=t.height=2,t.name=i.target="pushcentric-notify-iframe";var o=document.createElement("input");o.type="hidden",o.name="json",o.value=JSON.stringify(e),i.appendChild(o),document.body.appendChild(i),document.body.appendChild(t),i.submit(),n()}else console.log("skip notify due to cookie")}function t(e){return console.log(d),d?new Promise(function(n,i){console.log("sendSubscription: ",e),n()}):(e.url=location.href.split("#")[0],fetch(settingsProvider.endpointDomain+"/subscribe?domain="+settingsProvider.domainName+"&name="+settingsProvider.domainURL,{method:"POST",mode:"cors",credentials:"include",body:JSON.stringify(e),headers:{"content-type":"text/json"}}))}function o(e){var n=atob(e),i=new Uint8Array(n.length);for(let e=0;e<n.length;++e)i[e]=n.charCodeAt(e);return i}function r(e){if(d)return console.log("subscribeWithServiceWorker"),e();var n=o(settingsProvider.publicKey);return navigator.serviceWorker.getRegistration().then(function(e){return e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:n})}).then(function(n){t(n.toJSON()).then(e)})}function c(e){for(var n=window.location.search.substring(1),i=n.split("&"),t=0;t<i.length;t++){var o=i[t].split("=");if(o[0]===e)return decodeURI(o[1])}return""}function a(e,n){var i=document.location.href,t=i.indexOf("?")>-1?"&":"?";return i+t+e+"="+n}function s(){if("undefined"!=typeof moment&&!c("date")){var e=a("date",moment(new Date).tz("America/Los_Angeles").format("DDMMYYYY"));history.replaceState({},"",e)}}var d=!!c("debug");e()}();